# 你应该了解的统计方法：限制性立方样条
2023年2月2日 Didier Brassard, RD PhD，原文链接：https://didierbrassard.github.io/posts/2023/02/blog-post-1/

在本文中，我将介绍一种我认为非常实用的统计方法，并提供简要概述：限制性立方样条（restricted cubic splines）。在攻读博士学位期间，我在生物统计学课程中认真学习了回归模型的假设条件。对于线性回归模型而言，其中一个假设是自变量 X 应与因变量 Y 呈线性关系。毕竟，线性回归模型的核心就是估计线性关系，这一点合乎情理。但当我得知线性假设并非必需条件时，简直大吃一惊！我们可以通过简单的统计转换来放宽这一假设，限制性立方样条便是其中一种转换方法。

值得注意的是，有多种方法可用于建模非线性关系（Bennette and Vickers, 2012），但限制性立方样条具有一些其他文献中所讨论的优势（Desquilbet and Mariotti, 2010）。

## 为什么要考虑潜在的非线性关系？
通常情况下，线性回归模型会通过数据点拟合出一条“最佳拟合直线”。然而，这条“直线”（更常见的说法是“曲线”）可能无法很好地拟合数据（图1）。显然，**直线无法充分反映非线性关系**。问题在于，我们往往并不知晓变量之间“真实”关系的形状——而这正是我们试图通过模型来估计的核心内容！总而言之，**默认假设线性关系可能会掩盖变量间的真实关联**，进而导致错误的结论（Khan et al., 2019）。

**图1：直线作为回归曲线无法很好拟合非线性关系的示例场景**

**模型：Y | X，假设为线性关系** 

![](https://files.mdnice.com/user/63076/90587ce3-0fef-4d05-b564-83147ee02717.png)

## 什么是限制性立方样条（RCS）？
通俗地说，**立方样条是对连续自变量的一种转换，它允许曲线在预定值处平滑改变形状**。这些预定值被称为**节点（knots）**。“限制性”意味着曲线在最低节点以下和最高节点以上被强制呈线性。这一设定有助于避免数据过拟合（overfitting）。

如需更准确的定义和详细信息，请参阅 Harrell 教授的《回归建模策略》一书（Harrell, 2015）。

## 需要多少个节点？节点位置在哪里？
限制性立方样条转换是一种灵活的建模策略，但我们不应过度灵活。若曲线可改变形状的节点过多，可能会导致数据过拟合——也就是说，我们拟合出的曲线可能过于贴合当前数据，以至于失去了泛化能力。

应用限制性立方样条转换时，需确定节点的数量和位置。除非已知特定值的重要性相关背景信息，否则一种常用的启发式方案是**在预定分位数处设置 3 至 5 个节点**（见下表，来自 Harrell 教授的《回归建模策略》一书）。选择在分布中均匀分布的分位数，可确保节点之间有足够的信息来建模变量关系。有时，尤其是处理时间或日期数据时，可能需要超过 5 个节点，但在大多数情况下，3 至 5 个节点就足够了。

| 节点数量 | 位置       |
|----------|------------|
| 3        | 0.10 0.50 0.90 |
| 4        | 0.05 0.35 0.65 0.95 |
| 5        | 0.05 0.275 0.50 0.725 0.95 |
| 6        | 0.05 0.23 0.41 0.59 0.77 0.95 |
| 7        | 0.025 0.1833 0.3417 0.5 0.6583 0.8167 0.975 |

## 额外项
当对单个连续变量应用限制性立方样条转换后，会生成 k - 2 个额外变量（其中 k = 节点数量）。这些额外变量将与原始变量一起纳入模型。例如，原模型方程：

$$Y_i = \beta_0 + \beta_X X_i + \epsilon_i$$

对 X 应用 4 个节点的限制性立方样条转换后，模型方程变为：

$$Y_i = \beta_0 + \beta_X X_i + \beta_{X'} X_i' + \beta_{X''} X_i'' + \epsilon_i$$

此时，用于表示 X 的变量共有 3 个，包括 2 个（k - 2 = 2）额外的“非线性”项。在第二个方程中：
- $X_i$ 是原始变量，$\beta_X$ 是反映线性关系的系数；
- $X_i'$ 和 $X_i''$ 是由 X 转换得到的变量，$\beta_{X'}$ 和 $\beta_{X''}$ 是反映非线性关系（若存在）的系数；
- $X_i$、$X_i'$ 和 $X_i''$ 共同代表自变量，$\beta_X$、$\beta_{X'}$ 和 $\beta_{X''}$ 是反映 X 与 Y 之间完整关系的回归系数。

需要注意的是，**X 转换后的模型复杂度略有增加**。在上述示例中，用限制性立方样条建模自变量 X 需要 3 个参数，而并非原来的 1 个。**对于有效样本量较小的情况（例如 n < 100），这一问题不容忽视**，尤其是当需要考虑多个变量时。

总而言之，应结合有效样本量预先谨慎确定节点数量。**在样本量有限的情况下，一种可行的策略是为主要关注变量分配更多节点**（例如 k = 4 或 k = 5），而对其他不太可能起主要作用的变量分配较少节点（例如 k = 3），甚至直接假设其呈线性关系（不进行转换）。

## 应用转换
虽然可以手动计算，但包括R语言在内的统计软件提供了简便的转换工具（Perperoglou et al., 2019）。在 SAS 中，也可通过部分过程步的内置 `effect` 选项应用限制性立方样条转换。

下文将演示如何使用 R 语言的 `rms` 包应用限制性立方样条转换。对于 SAS 用户，也有相关的使用教程，链接：https://didierbrassard.github.io/files/blog2023_1_sas.txt。

## 在 R 语言中使用限制性立方样条的示例
### 数据准备与概述
为说明限制性立方样条如何灵活评估变量关系，我使用了 2015 年加拿大社区健康调查（CCHS）-营养调查的公开数据（地址：https://www150.statcan.gc.ca/n1/en/catalogue/82M0024X2018001）。本文将重点介绍限制性立方样条转换，因此不会详细说明调查设计相关内容。如需了解 CCHS 数据的分析细节，建议阅读这篇博文：https://didierbrassard.github.io/posts/2022/12/blog-post-8/；也可直接跳至下一章节。

```r
# ********************************************** #
#             加载所需包                          #
# ********************************************** #

library(tidyverse)
library(data.table)
library(parallel)
library(survey)
library(haven)

# ********************************************** #
#         加载并准备 CCHS 数据：HS 数据集         #
# ********************************************** #

# 注：由于文件存储在外部驱动器，此处使用硬编码路径（<external_drive>），请根据实际情况修改
# 通常分析应保证独立性，但调查数据文件较大
# 数据格式与从加拿大统计局获取时完全一致
external_drive <- "path/to/your/external/drive/"

# HS 数据文件（包含能量摄入、年龄、性别、抽样权重等信息）
cchs_data <- 
  haven::read_sas(data_file = file.path(external_drive,"CCHS_Nutrition_2015_PUMF","Data_Donnee","hs.sas7bdat"),
                  col_select = c(ADM_RNO,WTS_P,DHH_AGE,DHH_SEX,PHSGAPA)) |>
  ## 简化变量名
  dplyr::rename(AGE = DHH_AGE,
                SEX = DHH_SEX,
                PHYS_ACT_VIG = PHSGAPA) |>
  ## 仅保留 18-70 岁受访者，且能量数据非空
  dplyr::filter(AGE>=18, AGE<71) |>
  dplyr::mutate(
    ## 创建性别指示变量：男性=1，否则=0
    MALE = ifelse(SEX==1,1,0),
    ## 重新编码体力活动数据中的有效跳过/未说明项为缺失值（NA）
    PHYS_ACT_VIG = ifelse(PHYS_ACT_VIG>20,NA,PHYS_ACT_VIG)
  )

# ********************************************** #
#         加载并准备 CCHS 数据：B5 数据集         #
# ********************************************** #

# 自助重复权重（用于方差估计）
bsw <- 
  data.table::fread(file.path(external_drive,"CCHS_Nutrition_2015_PUMF","Bootstrap",
                               "Data_Donnee","b5.txt"),
                     stringsAsFactors = F, data.table= F, header=F,
                     nThread = parallel::detectCores()-1, # 注：略显冗余，但无妨
                     col.names = c("ADM_RNO","WTS_P",paste0("BSW",seq(1,500)))) |>
  # 仅保留上述已筛选出的受访者
  dplyr::right_join(cchs_data[,"ADM_RNO"]) |>
  # 移除抽样权重（避免在 <cchs_data> 中重复）
  dplyr::select(-WTS_P)

# ********************************************** #
#             指定调查设计                        #
# ********************************************** #

cchs_design_bsw <- 
  survey::svrepdesign(
    data =  cchs_data, # 包含感兴趣变量和抽样权重的 HS 数据
    type = "bootstrap", # CCHS 中的重复权重为 bootstrap 权重
    weights    = ~WTS_P, # 抽样权重
    repweights = bsw[,2:501], # bootstrap 重复权重（即 BSW1, BSW2, ..., BSW500）
    combined.weights=TRUE,  # 2015 年 CCHS 中权重已合并
    mse = TRUE # 基于点估计的平方和计算方差（与 SAS 一致）
  )

# ********************************************** #
#             检查调查对象                        #
# ********************************************** #

cchs_design_bsw
```

```
Call: svrepdesign.default(data = cchs_data, type = "bootstrap", weights = ~WTS_P, 
    repweights = bsw[, 2:501], combined.weights = TRUE, mse = TRUE)
Survey bootstrap with 500 replicates and MSE variances.
```

> 改编自加拿大统计局，2015 年加拿大社区健康调查 - 营养：公共使用微观数据文件，2023 年 2 月。

### 建模与限制性立方样条转换
该数据是 2015 年 CCHS - 营养调查中 18 - 70 岁受访者的子集。本分析旨在描述年龄和性别（自变量：`AGE`、`MALE`）与每周中等强度/高强度体力活动报告小时数（因变量：`PHYS_ACT_VIG`）之间的关系。线性回归模型方程如下：

$$PHYS\_ACT\_VIG = \beta_0 + \beta_{AGE} + \beta_{MALE} + \epsilon$$

对年龄应用 4 个节点的限制性立方样条转换后，模型方程变为：

$$PHYS\_ACT\_VIG = \beta_0 + \beta_{AGE} + \beta_{AGE'} + \beta_{AGE''} + \beta_{MALE} + \epsilon$$

注：`MALE` 是虚拟变量（编码为 0 或 1），而非年龄这样的连续变量，因此不进行转换。此外，为考虑调查设计，我使用了 `survey::svyglm` 函数。对于非调查数据，可直接移除 `design = cchs_design_bsw`，使用 R 基础包的 `glm` 函数。

```r
# ********************************************** #
#             加载所需包                          #
# ********************************************** #

library(rms) # rms 包包含高效的变量重编码函数 <rcs(x,k)>，其中 k 为节点数
# parameters 和 marginaleffects 包便于可视化模型输出
library(parameters)
library(marginaleffects)

# ********************************************** #
#             用模型评估变量关系              #
# ********************************************** #

svy_lm_rcs <- 
  survey::svyglm(design = cchs_design_bsw,
                PHYS_ACT_VIG ~ rcs(AGE,4) + MALE,
                family = gaussian(link="identity") )

# 打印对象
svy_lm_rcs
```

```
Call: svrepdesign.default(data = cchs_data, type = "bootstrap", weights = ~WTS_P, 
    repweights = bsw[, 2:501], combined.weights = TRUE, mse = TRUE)
Survey bootstrap with 500 replicates and MSE variances.

Call:  survey::svyglm(design = cchs_design_bsw, formula = PHYS_ACT_VIG ~ 
    rcs(AGE, 4) + MALE, family = gaussian(link = "identity"))

Coefficients:
     (Intercept)    rcs(AGE, 4)AGE   rcs(AGE, 4)AGE'  rcs(AGE, 4)AGE''  
         4.80080          -0.06851           0.16950          -0.51467  
            MALE  
         1.26006  

Degrees of Freedom: 11436 Total (i.e. Null);  495 Residual
  (36 observations deleted due to missingness)
Null Deviance:      186800 
Residual Deviance: 181600   AIC: 75240
```

```r
# ********************************************** #
#           生成模型参数                          #
# ********************************************** #

svy_lm_rcs_parm <-
  parameters::model_parameters(svy_lm_rcs) |> 
  as_tibble()

# 打印参数
svy_lm_rcs_parm
```

```
# A tibble: 5 × 9
  Parameter Coefficient     SE    CI  CI_low CI_high Statistic df_error        p
  <chr>           <dbl>  <dbl> <dbl>   <dbl>   <dbl>     <dbl>    <dbl>    <dbl>
1 (Interce…      4.80   0.567   0.95  3.69    5.92        8.46      495 2.99e-16
2 rcs(AGE,…     -0.0685 0.0200  0.95 -0.108  -0.0291     -3.42      495 6.84e- 4
3 rcs(AGE,…      0.170  0.0563  0.95  0.0590  0.280       3.01      495 2.72e- 3
4 rcs(AGE,…     -0.515  0.179   0.95 -0.866  -0.163      -2.88      495 4.18e- 3
5 MALE           1.26   0.231   0.95  0.806   1.71        5.45      495 8.00e- 8
```

模型的截距 $\beta_0 = 4.8$ 小时（95%CI：3.7, 5.9），表示当 `AGE=0` 且 `MALE=0`（即 2015 年加拿大 19 岁女性）时，每周中等强度/高强度体力活动的估计小时数。系数 $\beta_{MALE} = 1.3$ 小时（95%CI：0.8, 1.7），表示男性每周报告的体力活动小时数平均比女性多 1.3 小时。那么 $\beta_{AGE}$、$\beta_{AGE'}$ 和 $\beta_{AGE''}$ 代表什么呢？**应用限制性立方样条转换后，我们应通过图表解读结果，而非直接解释系数！**

### 可视化含限制性立方样条的模型
以下代码展示了如何使用 `marginaleffects` 包生成模型的预测值，以及如何用 `ggplot2` 绘制图表。

```r
# ********************************************** #
#     生成 PHYS_ACT_VIG 的预测值                   #
# ********************************************** #

curve <-
  marginaleffects::plot_predictions(model = svy_lm_rcs,
                                    condition =c("AGE","MALE"),
                                    draw=FALSE)

# ********************************************** #
#          用 ggplot2 绘制图表                    #
# ********************************************** #

# 对男性变量进行格式处理
curve$MALE_f <- 
  factor(curve$MALE,
         levels =c(1,0),
         labels =c("Males","Females"))

# 绘图
ggplot(data=curve,aes(x=AGE,color=MALE_f)) +
  ## 预测的限制性立方样条曲线
  geom_line(aes(x=AGE,y=estimate),size=1.2) +
  ## 95% 置信区间
  geom_line(aes(x=AGE,y=conf.low),linetype="longdash") +
  geom_line(aes(x=AGE,y=conf.high),linetype="longdash") +
  ## 改变默认颜色
  scale_color_manual("Sex",values=MetBrewer::met.brewer("Homer1",2)) +
  ## 标签
  labs(x="Age, years",y="Moderate/vigorous physical activity, hours",
       title="Moderate/vigorous physical activity by age and sex in Canadians 18-70 y",
       subtitle="CCHS 2015 - Nutrition",
       caption = "Age modeled as a restricted cubic spline with 4 knots") +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
```

**图2：用限制性立方样条建模的变量关系**  
18-70岁加拿大人按年龄和性别划分的中等强度/高强度体力活动  
2015年加拿大社区健康调查（CCHS）-营养调查  

![](https://files.mdnice.com/user/63076/3ec2b9a1-936d-43f4-8b0c-06decafad19b.png)

（年龄采用 4 个节点的限制性立方样条建模）


根据图2可知，中等强度/高强度体力活动的参与度在 30 岁以下最高，随后下降至约 35 岁；30 多岁后期至约 50 岁略有上升，之后直至 70 岁大幅下降。注：也可计算具体数值。

最后，未使用限制性立方样条转换的线性回归模型所生成的图表，将显示出近乎无关联的关系——也就是说，没有证据表明年龄与报告的中等强度/高强度体力活动相关（图3）！可以说，如果我们默认假设线性关系而不考虑潜在的非线性，就会忽略这些重要的细节。

```r
# ********************************************** #
#     用线性模型评估变量关系（无限制性立方样条）   #
# ********************************************** #

svy_lm_norcs <- 
  survey::svyglm(design = cchs_design_bsw,
                PHYS_ACT_VIG ~ AGE + MALE,
                family = gaussian(link="identity") )

# ********************************************** #
#     生成 PHYS_ACT_VIG 的预测值                   #
# ********************************************** #

  marginaleffects::plot_predictions(model = svy_lm_norcs,
                                    condition =c("AGE","MALE"),
                                    draw=TRUE) +
  labs(x="Age, years",y="Moderate/vigorous physical activity, hours",
       title="Moderate/vigorous physical activity by age and sex in Canadians 18-70 y",
       subtitle="CCHS 2015 - Nutrition",
       caption = "Age modeled assuming linearity") +
  theme_bw() +
  theme(
     panel.grid.minor = element_blank()
  )
```

**图3：未使用限制性立方样条建模的变量关系**  
18-70岁加拿大人按年龄和性别划分的中等强度/高强度体力活动  
2015年加拿大社区健康调查（CCHS）-营养调查  

![](https://files.mdnice.com/user/63076/2af5429f-c84a-4f20-969f-98fcad537dd8.png)

（年龄假设呈线性关系建模）

## 参考文献
Bennette, C. & Vickers, A. (2012) Against quantiles: categorization of continuous variables in epidemiologic research, and its discontents. BMC Med Res Methodol, 12, 21. doi:10.1186/1471-2288-12-21.

Desquilbet, L. & Mariotti, F. (2010) Dose‐response analyses using restricted cubic spline functions in public health research. Statistics in Medicine, 29(9), 1037-1057. doi:10.1002/sim.3841.

Harrell, F. E. (2015) General Aspects of Fitting Regression Models, Regression Modeling Strategies: With Applications to Linear Models, Logistic and Ordinal Regression, and Survival Analysis. Cham: Springer International Publishing, 13-44.

Khan, T. A., Chiavaroli, L., Zurbau, A. & Sievenpiper, J. L. (2019) A lack of consideration of a dose-response relationship can lead to erroneous conclusions regarding 100% fruit juice and the risk of cardiometabolic disease. Eur J Clin Nutr, 73(12), 1556-1560. doi:10.1038/s41430-019-0514-x.

Perperoglou, A., Sauerbrei, W., Abrahamowicz, M. & Schmid, M. (2019) A review of spline function procedures in R. BMC Med Res Methodol, 19(1), 46. doi:10.1186/s12874-019-0666-3.

标签：数据可视化、线性回归、限制性立方样条